events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Upstream services
    upstream api {
        server api:8080;
    }

    upstream web {
        server web:5173;
    }

    upstream admin {
        server admin:5174;
    }

    # API: api.localhost
    server {
        listen 80;
        server_name api.localhost;
        client_max_body_size 100M;

        # Block admin endpoints from public access
        location /admin {
            return 403;
        }

        location / {
            proxy_pass http://api;
            proxy_http_version 1.1;

            # Preserve headers for SiteResolver
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Web: general.localhost, programming.localhost, fiction.localhost
    server {
        listen 80;
        server_name general.localhost programming.localhost fiction.localhost;

        # 301 redirect legacy URLs without language prefix to /en/*
        location ~ ^/(books|authors|genres|search|about|library)(/.*)?$ {
            return 301 /en$uri;
        }

        # Homepage redirect to default language
        location = / {
            return 301 /en/;
        }

        # SPA routing - same response for bots and users
        location / {
            add_header X-SEO-Render "static" always;

            proxy_pass http://web;
            proxy_http_version 1.1;

            # Preserve headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support for Vite HMR
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # Admin: admin.localhost
    server {
        listen 80;
        server_name admin.localhost;

        location / {
            proxy_pass http://admin;
            proxy_http_version 1.1;

            # Preserve headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support for Vite HMR
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # Default: catch-all -> web (general)
    server {
        listen 80 default_server;
        server_name _;

        # 301 redirect legacy URLs without language prefix to /en/*
        location ~ ^/(books|authors|genres|search|about|library)(/.*)?$ {
            return 301 /en$uri;
        }

        # Homepage redirect to default language
        location = / {
            return 301 /en/;
        }

        # SPA routing - same response for bots and users
        location / {
            add_header X-SEO-Render "static" always;

            proxy_pass http://web;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
