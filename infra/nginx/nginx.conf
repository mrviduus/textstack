events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Upstream services
    upstream api {
        server api:8080;
    }

    upstream web {
        server web:5173;
    }

    upstream admin {
        server admin:5174;
    }

    upstream prerender {
        server prerender:3000;
    }

    # Bot detection - set $prerender_ua to 1 if crawler
    # IMPORTANT: Google-InspectionTool is used by Search Console URL Inspection.
    # Without it, GSC sees raw SPA â†’ "Crawled - currently not indexed".
    map $http_user_agent $prerender_ua {
        default 0;
        "~*googlebot" 1;
        "~*Google-InspectionTool" 1;
        "~*GoogleOther" 1;
        "~*AdsBot-Google" 1;
        "~*Mediapartners-Google" 1;
        "~*bingbot" 1;
        "~*yandex" 1;
        "~*baiduspider" 1;
        "~*facebookexternalhit" 1;
        "~*twitterbot" 1;
        "~*rogerbot" 1;
        "~*linkedinbot" 1;
        "~*embedly" 1;
        "~*quora link preview" 1;
        "~*showyoubot" 1;
        "~*outbrain" 1;
        "~*pinterest" 1;
        "~*slackbot" 1;
        "~*vkShare" 1;
        "~*W3C_Validator" 1;
        "~*whatsapp" 1;
        "~*applebot" 1;
        # SEO audit tools
        "~*seositecheckup" 1;
        "~*semrush" 1;
        "~*ahrefs" 1;
        "~*moz" 1;
        "~*screaming frog" 1;
        "~*dotbot" 1;
        "~*petalbot" 1;
    }

    # Core SEO routes - skip prerender, serve static SPA
    map $uri $is_seo_static_route {
        default 0;
        "~^/en/?$" 1;
        "~^/en/books" 1;
        "~^/en/authors" 1;
    }

    # API: api.localhost
    server {
        listen 80;
        server_name api.localhost;
        client_max_body_size 100M;

        # Block admin endpoints from public access
        location /admin {
            return 403;
        }

        location / {
            proxy_pass http://api;
            proxy_http_version 1.1;

            # Preserve headers for SiteResolver
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Web: general.localhost, programming.localhost, fiction.localhost
    server {
        listen 80;
        server_name general.localhost programming.localhost fiction.localhost;

        # 301 redirect legacy URLs without language prefix to /en/*
        location ~ ^/(books|authors|genres|search|about|library)(/.*)?$ {
            return 301 /en$uri;
        }

        # Homepage redirect to default language
        location = / {
            return 301 /en/;
        }

        # Prerender for bots - internal location
        # Uses http://web:5173 (internal Docker network) instead of $host
        location /prerender-internal/ {
            internal;
            add_header X-SEO-Render "prerender" always;
            proxy_pass http://prerender/;
            proxy_http_version 1.1;
            proxy_set_header Host web;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_connect_timeout 60s;
            proxy_read_timeout 60s;
        }

        location / {
            set $prerender 0;
            set $render_type "static";

            if ($prerender_ua) {
                set $prerender 1;
                set $render_type "prerender";
            }

            # Don't prerender static files
            if ($uri ~* "\.(js|css|xml|less|png|jpg|jpeg|gif|pdf|doc|txt|ico|rss|zip|mp3|rar|exe|wmv|doc|avi|ppt|mpg|mpeg|tif|wav|mov|psd|ai|xls|mp4|m4a|swf|dat|dmg|iso|flv|m4v|torrent|ttf|woff|svg|eot)$") {
                set $prerender 0;
                set $render_type "static";
            }

            # Core SEO routes: skip prerender, serve static SPA
            if ($is_seo_static_route) {
                set $prerender 0;
                set $render_type "static";
            }

            add_header X-SEO-Render $render_type always;

            # Prerender URL uses internal Docker address
            if ($prerender = 1) {
                rewrite ^(.*)$ /prerender-internal/http://web:5173$1 last;
            }

            proxy_pass http://web;
            proxy_http_version 1.1;

            # Preserve headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support for Vite HMR
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # Admin: admin.localhost
    server {
        listen 80;
        server_name admin.localhost;

        location / {
            proxy_pass http://admin;
            proxy_http_version 1.1;

            # Preserve headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support for Vite HMR
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # Default: catch-all -> web (general)
    server {
        listen 80 default_server;
        server_name _;

        # 301 redirect legacy URLs without language prefix to /en/*
        location ~ ^/(books|authors|genres|search|about|library)(/.*)?$ {
            return 301 /en$uri;
        }

        # Homepage redirect to default language
        location = / {
            return 301 /en/;
        }

        # Prerender for bots - internal location
        location /prerender-internal/ {
            internal;
            proxy_pass http://prerender/;
            proxy_http_version 1.1;
            proxy_set_header Host web;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_connect_timeout 60s;
            proxy_read_timeout 60s;
        }

        location / {
            set $prerender 0;
            set $render_type "static";

            if ($prerender_ua) {
                set $prerender 1;
                set $render_type "prerender";
            }

            # Don't prerender static files
            if ($uri ~* "\.(js|css|xml|less|png|jpg|jpeg|gif|pdf|doc|txt|ico|rss|zip|mp3|rar|exe|wmv|doc|avi|ppt|mpg|mpeg|tif|wav|mov|psd|ai|xls|mp4|m4a|swf|dat|dmg|iso|flv|m4v|torrent|ttf|woff|svg|eot)$") {
                set $prerender 0;
                set $render_type "static";
            }

            # Core SEO routes: skip prerender, serve static SPA
            if ($is_seo_static_route) {
                set $prerender 0;
                set $render_type "static";
            }

            add_header X-SEO-Render $render_type always;

            # Prerender URL uses internal Docker address
            if ($prerender = 1) {
                rewrite ^(.*)$ /prerender-internal/http://web:5173$1 last;
            }

            proxy_pass http://web;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
