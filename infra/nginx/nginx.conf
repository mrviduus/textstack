events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Upstream services
    upstream api {
        server api:8080;
    }

    upstream web {
        server web:5173;
    }

    upstream admin {
        server admin:5174;
    }

    # API: api.localhost
    server {
        listen 80;
        server_name api.localhost;
        client_max_body_size 100M;

        location / {
            proxy_pass http://api;
            proxy_http_version 1.1;

            # Preserve headers for SiteResolver
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Web: general.localhost, programming.localhost, fiction.localhost
    server {
        listen 80;
        server_name general.localhost programming.localhost fiction.localhost;

        # Static files root (SSG output)
        root /var/www/static;

        # 301 redirect legacy URLs without language prefix to /en/*
        location ~ ^/(books|authors|genres|search|about|library)(/.*)?$ {
            return 301 /en$uri;
        }

        # Static assets from Next.js build (_next directory)
        location /_next/ {
            try_files $uri =404;
        }

        # Try static files first, fall back to Vite proxy
        location / {
            # Try: exact file -> directory index -> Vite proxy
            try_files $uri $uri/index.html @vite;
        }

        # Vite proxy fallback (for dev mode)
        location @vite {
            proxy_pass http://web;
            proxy_http_version 1.1;

            # Preserve headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support for Vite HMR
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # Admin: admin.localhost
    server {
        listen 80;
        server_name admin.localhost;

        location / {
            proxy_pass http://admin;
            proxy_http_version 1.1;

            # Preserve headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support for Vite HMR
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # Default: catch-all -> web (general)
    server {
        listen 80 default_server;
        server_name _;

        # Static files root (SSG output)
        root /var/www/static;

        # 301 redirect legacy URLs without language prefix to /en/*
        location ~ ^/(books|authors|genres|search|about|library)(/.*)?$ {
            return 301 /en$uri;
        }

        # Static assets from Next.js build (_next directory)
        location /_next/ {
            try_files $uri =404;
        }

        # Try static files first, fall back to Vite proxy
        location / {
            try_files $uri $uri/index.html @vite;
        }

        # Vite proxy fallback (for dev mode)
        location @vite {
            proxy_pass http://web;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
