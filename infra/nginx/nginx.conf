events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Upstream services
    upstream api {
        server api:8080;
    }

    upstream web {
        server web:5173;
    }

    upstream admin {
        server admin:5174;
    }

    # API: api.localhost
    server {
        listen 80;
        server_name api.localhost;
        client_max_body_size 100M;

        # Block admin endpoints from public access
        location /admin {
            return 403;
        }

        location / {
            proxy_pass http://api;
            proxy_http_version 1.1;

            # Preserve headers for SiteResolver
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Web: general.localhost, programming.localhost, fiction.localhost
    server {
        listen 80;
        server_name general.localhost programming.localhost fiction.localhost;

        # Root for built assets and SSG pages
        root /var/www/dist;

        # 301 redirect legacy URLs without language prefix to /en/*
        location ~ ^/(books|authors|genres|search|about|library)(/.*)?$ {
            return 301 /en$uri;
        }

        # Homepage redirect to default language
        location = / {
            return 301 /en/;
        }

        # SSG pages - serve pre-rendered HTML if exists
        # Homepage
        location ~ ^/(en|uk)/?$ {
            add_header X-SEO-Render "ssg" always;
            try_files /ssg$uri/index.html @spa;
        }

        # Book detail pages
        location ~ ^/(en|uk)/books/[^/]+/?$ {
            add_header X-SEO-Render "ssg" always;
            try_files /ssg$uri/index.html @spa;
        }

        # Author detail pages
        location ~ ^/(en|uk)/authors/[^/]+/?$ {
            add_header X-SEO-Render "ssg" always;
            try_files /ssg$uri/index.html @spa;
        }

        # Genre detail pages
        location ~ ^/(en|uk)/genres/[^/]+/?$ {
            add_header X-SEO-Render "ssg" always;
            try_files /ssg$uri/index.html @spa;
        }

        # List pages (books, authors, genres, about)
        location ~ ^/(en|uk)/(books|authors|genres|about)/?$ {
            add_header X-SEO-Render "ssg" always;
            try_files /ssg$uri/index.html @spa;
        }

        # Static assets - serve from dist
        location /assets/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # SEO files - proxy to API
        location = /robots.txt {
            proxy_pass http://api/robots.txt;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location = /sitemap.xml {
            proxy_pass http://api/sitemap.xml;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /sitemaps/ {
            proxy_pass http://api/sitemaps/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        # API proxy
        location /api/ {
            proxy_pass http://api/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Storage proxy (book covers, files)
        location /storage/ {
            proxy_pass http://api/storage/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        # SPA fallback for non-SSG routes (reader, library, search)
        location @spa {
            add_header X-SEO-Render "spa" always;
            add_header X-Robots-Tag "noindex, follow" always;

            proxy_pass http://web;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Default - SPA
        location / {
            add_header X-SEO-Render "spa" always;
            add_header X-Robots-Tag "noindex, follow" always;

            proxy_pass http://web;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # Admin: admin.localhost
    server {
        listen 80;
        server_name admin.localhost;

        location / {
            proxy_pass http://admin;
            proxy_http_version 1.1;

            # Preserve headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support for Vite HMR
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # Default: catch-all -> web (general)
    server {
        listen 80 default_server;
        server_name _;

        # 301 redirect legacy URLs without language prefix to /en/*
        location ~ ^/(books|authors|genres|search|about|library)(/.*)?$ {
            return 301 /en$uri;
        }

        # Homepage redirect to default language
        location = / {
            return 301 /en/;
        }

        # SPA routing - same response for bots and users
        location / {
            add_header X-SEO-Render "static" always;

            proxy_pass http://web;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
