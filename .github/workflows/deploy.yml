name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      rollback_commit:
        description: 'Commit SHA to rollback to (optional)'
        required: false

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  PROJECT_DIR: /home/vasyl/projects/onlinelib/onlinelib

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  deploy:
    needs: ci
    runs-on: self-hosted

    steps:
      - name: Pre-deploy backup
        run: |
          mkdir -p ~/backups
          DATE=$(date +%F-%H%M)
          docker exec textstack_db_prod pg_dump -U textstack_prod textstack_prod | gzip > ~/backups/pre-deploy-$DATE.sql.gz
          echo "Backup created: pre-deploy-$DATE.sql.gz"

      - name: Pull latest code
        run: |
          cd $PROJECT_DIR
          git fetch origin
          if [ -n "${{ github.event.inputs.rollback_commit }}" ]; then
            git checkout ${{ github.event.inputs.rollback_commit }}
          else
            git checkout main
            git pull origin main
          fi

      - name: Build frontend
        run: |
          cd $PROJECT_DIR/apps/web
          pnpm install
          VITE_API_URL=/api VITE_CANONICAL_URL=https://textstack.app pnpm build

      - name: Deploy containers
        run: |
          cd $PROJECT_DIR
          docker compose up -d --build

      - name: Wait for services
        run: sleep 30

      - name: Health check API
        run: |
          curl -sf http://localhost:8080/health || exit 1
          echo "API health check passed"

      - name: Run SSG prerender
        run: |
          cd $PROJECT_DIR/apps/web
          API_URL=http://localhost:8080 API_HOST=textstack.app CONCURRENCY=4 node scripts/prerender.mjs

      - name: Update nginx config
        run: |
          cd $PROJECT_DIR
          sed "s|/home/vasyl/projects/onlinelib/onlinelib|$PROJECT_DIR|g" \
            infra/nginx/textstack.conf | sudo tee /etc/nginx/sites-available/textstack > /dev/null
          sudo nginx -t && sudo systemctl reload nginx

      - name: Health check frontend
        run: |
          curl -sf http://localhost:80 || exit 1
          echo "Frontend health check passed"

      - name: Cleanup old images
        run: docker image prune -f
