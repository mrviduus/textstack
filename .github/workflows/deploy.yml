name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      rollback_commit:
        description: 'Commit SHA to rollback to (optional)'
        required: false

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  PROJECT_DIR: /home/vasyl/projects/onlinelib/textstack

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  deploy:
    needs: ci
    runs-on: self-hosted

    steps:
      - name: Pre-deploy backup
        run: |
          mkdir -p ~/backups
          DATE=$(date +%F-%H%M)
          docker exec textstack_db_prod pg_dump -U textstack_prod textstack_prod | gzip > ~/backups/pre-deploy-$DATE.sql.gz
          echo "Backup created: pre-deploy-$DATE.sql.gz"

      - name: Pull latest code
        run: |
          cd $PROJECT_DIR
          git fetch origin
          if [ -n "${{ github.event.inputs.rollback_commit }}" ]; then
            git checkout ${{ github.event.inputs.rollback_commit }}
          else
            git checkout main
            git pull origin main
          fi

      - name: Clean dist/ssg before build
        run: |
          cd $PROJECT_DIR/apps/web
          # Remove ssg folder if owned by root (Docker) - will be rebuilt after
          if [ -d dist/ssg ]; then
            docker run --rm -v "$PWD/dist:/dist" alpine rm -rf /dist/ssg /dist/ssg-old /dist/ssg-new 2>/dev/null || true
          fi

      - name: Build frontend
        run: |
          cd $PROJECT_DIR/apps/web
          pnpm install
          VITE_API_URL=/api VITE_CANONICAL_URL=https://textstack.app pnpm build

      - name: Deploy containers
        run: |
          cd $PROJECT_DIR
          docker compose up -d --build

      - name: Wait for services
        run: sleep 30

      - name: Health check API
        run: |
          curl -sf http://localhost:8080/health || exit 1
          echo "API health check passed"

      - name: Run SSG prerender (atomic swap)
        run: |
          cd $PROJECT_DIR/apps/web

          # Build to temp dir
          API_URL=http://localhost:8080 API_HOST=textstack.app CONCURRENCY=4 \
            node scripts/prerender.mjs --output-dir dist/ssg-new

          # Atomic swap
          rm -rf dist/ssg-old
          [ -d dist/ssg ] && mv dist/ssg dist/ssg-old || true
          mv dist/ssg-new dist/ssg
          rm -rf dist/ssg-old

          echo "SSG atomic swap completed"

      # nginx config update requires sudo - run manually via `make deploy` when config changes

      - name: Health check frontend
        run: |
          curl -sf http://localhost:80 || exit 1
          echo "Frontend health check passed"

      - name: Cleanup old images
        run: docker image prune -f
